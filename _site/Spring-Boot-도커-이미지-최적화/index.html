<!DOCTYPE html> <html lang="en-US"> <head prefix="og: http://ogp.me/ns#"> <meta charset="UTF-8" /> <meta http-equiv="X-UA-Compatible" content="ie=edge" /> <meta name="viewport" content="width=device-width, initial-scale=1.0" /> <meta name="mobile-web-app-capable" content="yes" /> <meta name="apple-mobile-web-app-capable" content="yes" /> <meta name="application-name" content="Ohjongsung's Dev Story" /> <meta name="apple-mobile-web-app-status-bar-style" content="#fff" /> <meta name="apple-mobile-web-app-title" content="Ohjongsung's Dev Story" /> <title> Spring Boot 도커 이미지 최적화 - Ohjongsung's Dev Story </title> <link rel="alternate" href="http://localhost:4000/Spring-Boot-%EB%8F%84%EC%BB%A4-%EC%9D%B4%EB%AF%B8%EC%A7%80-%EC%B5%9C%EC%A0%81%ED%99%94/" hreflang="en-US" /> <link rel="canonical" href="http://localhost:4000/Spring-Boot-%EB%8F%84%EC%BB%A4-%EC%9D%B4%EB%AF%B8%EC%A7%80-%EC%B5%9C%EC%A0%81%ED%99%94/" /> <meta name="description" content="개발 블로그입니다. @github." /> <meta name="referrer" content="no-referrer-when-downgrade" /> <meta property="fb:app_id" content="" /> <meta property="og:site_name" content="Spring Boot 도커 이미지 최적화 | Ohjongsung's Dev Story" /> <meta property="og:title" content="Spring Boot 도커 이미지 최적화 | Ohjongsung's Dev Story" /> <meta property="og:type" content="website" /> <meta property="og:url" content="http://localhost:4000/Spring-Boot-%EB%8F%84%EC%BB%A4-%EC%9D%B4%EB%AF%B8%EC%A7%80-%EC%B5%9C%EC%A0%81%ED%99%94/" /> <meta property="og:description" content="개발 블로그입니다. @github." /> <meta property="og:image" content="http://localhost:4000/assets/img/ogp.png" /> <meta property="og:image:width" content="640" /> <meta property="og:image:height" content="640" /> <meta name="twitter:card" content="summary" /> <meta name="twitter:title" content="Spring Boot 도커 이미지 최적화 | " /> <meta name="twitter:url" content="http://localhost:4000/Spring-Boot-%EB%8F%84%EC%BB%A4-%EC%9D%B4%EB%AF%B8%EC%A7%80-%EC%B5%9C%EC%A0%81%ED%99%94/" /> <meta name="twitter:site" content="@" /> <meta name="twitter:creator" content="@" /> <meta name="twitter:description" content="개발 블로그입니다. @github." /> <meta name="twitter:image" content="http://localhost:4000/assets/img/ogp.png" /> <link type="application/atom+xml" rel="alternate" href="http://localhost:4000/feed.xml" title="Ohjongsung's Dev Story" /> <link rel="apple-touch-icon" sizes="180x180" href="/assets/favicons/apple-touch-icon.png" /> <link rel="icon" type="image/png" sizes="32x32" href="/assets/favicons/favicon-32x32.png" /> <link rel="icon" type="image/png" sizes="16x16" href="/assets/favicons/favicon-16x16.png" /> <link rel="manifest" href="/assets/favicons/site.webmanifest" /> <link rel="mask-icon" href="/assets/favicons/safari-pinned-tab.svg" color="#5bbad5" /> <meta name="apple-mobile-web-app-title" content="Jekyll Klise" /> <meta name="application-name" content="Jekyll Klise" /> <meta name="msapplication-TileColor" content="#da532c" /> <meta name="theme-color" content="#2c2c2c" /> <link rel="stylesheet" href="/assets/css/style.css" /> </head> <body data-theme="light" class="notransition"> <script> const body = document.body; const data = body.getAttribute("data-theme"); const initTheme = (state) => { if (state === "dark") { body.setAttribute("data-theme", "dark"); } else if (state === "light") { body.removeAttribute("data-theme"); } else { localStorage.setItem("theme", data); } }; initTheme(localStorage.getItem("theme")); setTimeout(() => body.classList.remove("notransition"), 75); </script> <div class="navbar" role="navigation"> <nav class="menu"> <input type="checkbox" id="menu-trigger" class="menu-trigger" /> <label for="menu-trigger"> <span class="menu-icon"> <svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 512 512" > <path d="M64,384H448V341.33H64Zm0-106.67H448V234.67H64ZM64,128v42.67H448V128Z" /> </svg> </span> </label> <a id="mode"> <svg class="mode-sunny" xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 512 512" > <title>LIGHT</title> <line x1="256" y1="48" x2="256" y2="96" style="stroke-linecap:round;stroke-miterlimit:10;stroke-width:32px" /> <line x1="256" y1="416" x2="256" y2="464" style="stroke-linecap:round;stroke-miterlimit:10;stroke-width:32px" /> <line x1="403.08" y1="108.92" x2="369.14" y2="142.86" style="stroke-linecap:round;stroke-miterlimit:10;stroke-width:32px" /> <line x1="142.86" y1="369.14" x2="108.92" y2="403.08" style="stroke-linecap:round;stroke-miterlimit:10;stroke-width:32px" /> <line x1="464" y1="256" x2="416" y2="256" style="stroke-linecap:round;stroke-miterlimit:10;stroke-width:32px" /> <line x1="96" y1="256" x2="48" y2="256" style="stroke-linecap:round;stroke-miterlimit:10;stroke-width:32px" /> <line x1="403.08" y1="403.08" x2="369.14" y2="369.14" style="stroke-linecap:round;stroke-miterlimit:10;stroke-width:32px" /> <line x1="142.86" y1="142.86" x2="108.92" y2="108.92" style="stroke-linecap:round;stroke-miterlimit:10;stroke-width:32px" /> <circle cx="256" cy="256" r="80" style="stroke-linecap:round;stroke-miterlimit:10;stroke-width:32px" /> </svg> <svg class="mode-moon" xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 512 512" > <title>DARK</title> <line x1="256" y1="48" x2="256" y2="96" style="stroke-linecap:round;stroke-miterlimit:10;stroke-width:32px" /> <line x1="256" y1="416" x2="256" y2="464" style="stroke-linecap:round;stroke-miterlimit:10;stroke-width:32px" /> <line x1="403.08" y1="108.92" x2="369.14" y2="142.86" style="stroke-linecap:round;stroke-miterlimit:10;stroke-width:32px" /> <line x1="142.86" y1="369.14" x2="108.92" y2="403.08" style="stroke-linecap:round;stroke-miterlimit:10;stroke-width:32px" /> <line x1="464" y1="256" x2="416" y2="256" style="stroke-linecap:round;stroke-miterlimit:10;stroke-width:32px" /> <line x1="96" y1="256" x2="48" y2="256" style="stroke-linecap:round;stroke-miterlimit:10;stroke-width:32px" /> <line x1="403.08" y1="403.08" x2="369.14" y2="369.14" style="stroke-linecap:round;stroke-miterlimit:10;stroke-width:32px" /> <line x1="142.86" y1="142.86" x2="108.92" y2="108.92" style="stroke-linecap:round;stroke-miterlimit:10;stroke-width:32px" /> <circle cx="256" cy="256" r="80" style="stroke-linecap:round;stroke-miterlimit:10;stroke-width:32px" /> </svg> </a> <div class="trigger"> <div class="trigger-container"><a class="menu-link" href="/">home</a><a class="menu-link" href="/archive/">archive</a><a class="menu-link" href="https://github.com/ohjongsung" target="_blank" rel="noopener" >github</a ><a class="menu-link rss" href="/feed.xml"> <svg xmlns="http://www.w3.org/2000/svg" width="17" height="17" viewBox="0 0 512 512" fill="#ED812E" > <title>RSS</title> <path d="M108.56,342.78a60.34,60.34,0,1,0,60.56,60.44A60.63,60.63,0,0,0,108.56,342.78Z" /> <path d="M48,186.67v86.55c52,0,101.94,15.39,138.67,52.11s52,86.56,52,138.67h86.66C325.33,312.44,199.67,186.67,48,186.67Z" /> <path d="M48,48v86.56c185.25,0,329.22,144.08,329.22,329.44H464C464,234.66,277.67,48,48,48Z" /> </svg> </a> </div> </div> </nav> </div> <div class="wrapper post"> <main class="page-content" aria-label="Content"> <article itemscope itemtype="https://schema.org/BlogPosting"> <header class="header"> <h1 class="header-title" itemprop="headline">Spring Boot 도커 이미지 최적화</h1> <div class="post-meta"> <time datetime="2019-10-20T00:00:00+09:00" itemprop="datePublished"> 2019-10-20 </time> <span itemprop="author" itemscope itemtype="https://schema.org/Person"> <span itemprop="name">Ohjongsung's Dev Story</span> </span> <time hidden datetime="" itemprop="dateModified"> Oct 20, 2019 </time> <span hidden itemprop="publisher" itemtype="Person">Ohjongsung's Dev Story</span> <span hidden itemprop="image"></span> <span hidden itemprop="mainEntityOfPage"><p>JAVA, 그러니까 Spring Application 을 도커 이미지로 만들어 보면, 500 ~ 700M 사이즈의 이미지가 생성된다. 이는 일반 OS 이미지를 사용하고 필요없는 툴이나 파일까지 포함해서 생성했기 때문이다. 그러나 이를 최적화하면 빌드와 배포 시간을 단축할 수 있다. 최적화에는이미지 사이즈를 줄이고 레이어를 세분화 해서 캐시를 활용하는 두 가지 방법이 있다.</p> </span> </div> </header> <div class="page-content" itemprop="articleBody"> <p>JAVA, 그러니까 Spring Application 을 도커 이미지로 만들어 보면, 500 ~ 700M 사이즈의 이미지가 생성된다. 이는 일반 OS 이미지를 사용하고 필요없는 툴이나 파일까지 포함해서 생성했기 때문이다. 그러나 이를 최적화하면 빌드와 배포 시간을 단축할 수 있다. 최적화에는이미지 사이즈를 줄이고 레이어를 세분화 해서 캐시를 활용하는 두 가지 방법이 있다.</p> <h2 id="이미지-사이즈-경량화"> <a href="#이미지-사이즈-경량화" class="anchor-head"></a> 이미지 사이즈 경량화 </h2> <p>알파인 리눅스는 가볍고 간단하고 보안성을 목적으로 개발한 리눅스 배포판이다.</p> <p><img src="Docker_Image_Size.png" alt="Docker_Image_Size" /></p> <h3 id="java-알파인-이미지"> <a href="#java-알파인-이미지" class="anchor-head"></a> Java 알파인 이미지 </h3> <p>alpine linux를 기본으로 해서, 애플리케이션 구동을 위한 이미지들이 이미 많이 있는데, java의 경우 openjdk 기반의 다양한 이미지가 있다.</p> <p><img src="Java_Image_Size.PNG" alt="Java_Image_Size" /></p> <p>이미지 사이즈를 보면 사이즈 차이가 많이 나는데, adoptopenjdk/openjdk{version}:alpine-jre 를 사용하는 것이 좋다. slim prefix가 붙은 이미지의 사이즈가 가장 작은데, 이는 openjdk -headless 패키지를 사용한 것으로 자바 런타임 환경에서 필요한 최소한의 패키지만 설치되어 있다. 그러나 openjdk 만 사용되고 공간 제약이 있는 경우에만 사용해야 한다. 그 외에 추가로 실행되어야 하는 agent 나 daemon 이 있는 경우, 실행이 안될 가능성이 높아 테스트가 필요하다.</p> <p>여기서 더 나아가서 사이즈가 가장 작은 이미지를 베이스로 삼고 필요한 라이브러리, 툴을 추가해서 커스텀 이미지를 만들 수도 있다.</p> <h3 id="jdk보다는-jre"> <a href="#jdk보다는-jre" class="anchor-head"></a> JDK보다는 JRE </h3> <p>자바 런타임용 컨테이너를 만들때, 컴파일러가 포함된 JDK 환경을 사용한다는 것이다. 보통 자바 런타임은 JDK 없이 JRE 만 있어도 충분하다. 이미지 생성 과정에 JDK 가 필요하다면, 멀티-스테이지 빌드를 활용하자.</p> <div class="language-dockerfile highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="k">FROM</span><span class="w"> </span><span class="s">openjdk:11-jdk</span><span class="w"> </span><span class="k">as</span><span class="w"> </span><span class="s">builder</span>
<span class="k">WORKDIR</span><span class="s"> application</span>
<span class="k">ARG</span><span class="s"> JAR_FILE=target/*.jar</span>
<span class="k">COPY</span><span class="s"> ${JAR_FILE} application.jar</span>
<span class="k">RUN </span>java <span class="nt">-Djarmode</span><span class="o">=</span>layertools <span class="nt">-jar</span> application.jar extract
<span class="k">FROM</span><span class="s"> adoptopenjdk:11-jre-hotspot</span>
<span class="k">WORKDIR</span><span class="s"> application</span>
<span class="k">COPY</span><span class="s"> --from=builder application/dependencies/ ./</span>
<span class="k">COPY</span><span class="s"> --from=builder application/snapshot-dependencies/ ./</span>
<span class="k">COPY</span><span class="s"> --from=builder application/resources/ ./</span>
<span class="k">COPY</span><span class="s"> --from=builder application/application/ ./</span>
<span class="k">ENTRYPOINT</span><span class="s"> ["java", "org.springframework.boot.loader.JarLauncher"]</span>
</code></pre></div></div> <p>위의 샘플을 보면 빌드 단계에선 JDK 이미지를 활용하고 실제 런타임용 컨테이너를 만들때는 JRE 이미지를 사용한다.</p> <h2 id="이미지-레이어-세분화"> <a href="#이미지-레이어-세분화" class="anchor-head"></a> 이미지 레이어 세분화 </h2> <p>간단한 Java 애플리키에션을 만들고 도커 파일을 작성하자.</p> <div class="language-dockerfile highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="k">FROM</span><span class="s"> openjdk:11-jre-slim</span>

<span class="k">WORKDIR</span><span class="s"> /root</span>
<span class="k">COPY</span><span class="s"> build/libs/demo-0.0.1-SNAPSHOT.jar .</span>
<span class="k">CMD</span><span class="s"> java -jar demo-0.0.1-SNAPSHOT.jar</span>
</code></pre></div></div> <p>이미지를 빌드하고 푸쉬하면,</p> <div class="language-text highlighter-rouge"><div class="highlight"><pre class="highlight"><code># The push refers to repository [docker.io/perfectacle/spring-boot-demo]
# b61d0959344e: Pushing [================&gt;                                  ]  6.096MB/18.22MB
# 4bbad98352e9: Mounted from library/openjdk 
# 9f6ec1d0a99c: Mounted from library/openjdk 
# 8eb822456baf: Mounted from library/openjdk 
# 0d59dc1d96ca: Mounted from library/openjdk 
# 93df8ce6d131: Mounted from library/openjdk 
# 5dacd731af1b: Mounted from library/openjdk
</code></pre></div></div> <p>로그를 보면 Dockerfile 의 From 에 선언한 openjdk:11-jre-slim 이미지의 레이어에서부터 쌓아간다. 4bbad98352e9 ~ 5dacd731af1b까지가 openjdk:11-jre-slim 이미지의 레이어를 사용한 것이다. 그리고 제일 윗 라인에 b61d0959344e 이 부분이 Dockerfile 의 COPY 에 의해 생긴 레이어다. JAR 파일이 하나의 레이어를 차지하고 있는 것이다.</p> <p>Application 의 소스를 수정하고 다시 빌드해보면, JAR 부분 이미지 레이어가 재생성되는 것을 볼 수 있다.</p> <div class="language-text highlighter-rouge"><div class="highlight"><pre class="highlight"><code>54f0c4fe51ff: Pushing [=&gt;                                                 ]  590.8kB/18.22MB
# 4bbad98352e9: Layer already exists 
# 9f6ec1d0a99c: Layer already exists 
# 8eb822456baf: Layer already exists 
# 0d59dc1d96ca: Layer already exists 
# 93df8ce6d131: Layer already exists 
# 5dacd731af1b: Layer already exists
</code></pre></div></div> <p>4bbad98352e9 ~ 5dacd731af1b까지가 openjdk:11-jre-slim 이미지의 레이어이고,</p> <p>이전 이미지에서 이미 생성해서 Docker Registry 에 캐시되어 있다. 따라서 해당 레이어는 재활용된다. 재활용 된다는 것은 push/pull 동작이 필요치 않아 빌드 속도에 큰 영향을 주게 된다. 게다가 실제 디스크에서 차지하는 용량도 해당 레이어를 재활용하기 때문에 매우 효율적이다.</p> <p>반면에 JAR 파일에는 소스 코드, 환경 정보, 리소스, 디펜던시 라이브러리 등 모든 것이 담겨있다. 이를 Fat Jar라고 하는데, 효율적이지 못하다. 나열한 포함 요소들 중 하나라도 변경되면 해당 레이어는 캐시를 활용하지 못하고 재생성 되어야 한다.</p> <h3 id="spring-boot-application"> <a href="#spring-boot-application" class="anchor-head"></a> Spring Boot Application </h3> <p>Spring boot 와 같은 자바 애플리케이션은 애플리케이션 파일은 /classes에 저장되지만, 나머지 참조하는 여러 jar 파일들이 있다. 이러한 jar 파일들은 변경이 없기 때문에, 다시 재배포할 필요 없이 캐시 하도록 레이어를 분리하는 것이 좋다.</p> <p>그래서, 아래와 같이 애플리케이션 jar 파일을 푼 다음에, 각각의 디렉토리를 별도로 복사하는 방법을 사용한다. mvn package 에 의해서 생성된 jar 파일을 target/depdency 라는 디렉토리에 풀고, 각 디렉토리를 Dockerfile에서 각각 복사하도록 설정할 수 있다.</p> <div class="language-dockerfile highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="k">FROM</span><span class="s"> openjdk:11-jre-slim</span>

<span class="k">WORKDIR</span><span class="s"> /root</span>
<span class="k">ARG</span><span class="s"> DEPENDENCY=target/dependency</span>
<span class="k">COPY</span><span class="s"> ${DEPENDENCY}/BOOT-INF/lib /app/lib</span>
<span class="k">COPY</span><span class="s"> ${DEPENDENCY}/META-INF /app/META-INF</span>
<span class="k">COPY</span><span class="s"> ${DEPENDENCY}/BOOT-INF/classes /app</span>

<span class="k">ENTRYPOINT</span><span class="s"> ["java","-cp","app:app/lib/*","com.example.demo.DemoApplication"]</span>
</code></pre></div></div> <p>빌드 스크립트 :</p> <div class="language-bash highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="c"># maven</span>
<span class="nb">mkdir</span> <span class="nt">-p</span> target/dependency <span class="o">&amp;&amp;</span> <span class="o">(</span><span class="nb">cd </span>target/dependency<span class="p">;</span> jar <span class="nt">-xf</span> ../<span class="k">*</span>.jar<span class="o">)</span>

<span class="c"># gradle</span>
<span class="nb">mkdir</span> <span class="nt">-p</span> build/dependency <span class="o">&amp;&amp;</span> <span class="o">(</span><span class="nb">cd </span>build/dependency<span class="p">;</span> jar <span class="nt">-xf</span> ../libs/<span class="k">*</span>.jar<span class="o">)</span>
</code></pre></div></div> <p>이를 새롭게 빌드 푸쉬해보면, 레이어가 추가된 것이 보인다.</p> <div class="language-text highlighter-rouge"><div class="highlight"><pre class="highlight"><code>aefdad4cf83c: Pushing [=&gt;                                                 ]  592.9kB/18.12MB
# 3asdf23fge23: Pushing [==================================================&gt;]  45.728kB
# c1asdf1254sd: Pushing [==================================================&gt;]  20.728kB
# b13asd36b507: Pushing [==================================================&gt;]  12.728kB
# 4bbad98352e9: Layer already exists 
# 9f6ec1d0a99c: Layer already exists 
# 8eb822456baf: Layer already exists 
# 0d59dc1d96ca: Layer already exists 
# 93df8ce6d131: Layer already exists 
# 5dacd731af1b: Layer already exists
</code></pre></div></div> <p>이제 소스를 수정하면, 소스 레이어만 새롭게 생성되고 나머진 캐시를 활용하게 된다. 그러면 빌드, 배포 속도가 기존보다 빨라진다.</p> <div class="language-text highlighter-rouge"><div class="highlight"><pre class="highlight"><code>aefdad4cf83c: Pushing [=&gt;                                                 ]  592.9kB/18.12MB
# 3asdf23fge23: Layer already exists
# c1asdf1254sd: Layer already exists
# b13asd36b507: Layer already exists
# 4bbad98352e9: Layer already exists 
# 9f6ec1d0a99c: Layer already exists 
# 8eb822456baf: Layer already exists 
# 0d59dc1d96ca: Layer already exists 
# 93df8ce6d131: Layer already exists 
# 5dacd731af1b: Layer already exists
</code></pre></div></div> <p>여기서 알아야할 것은 만약 라이브러리 디펜시가 수정되어 해당 레이어가 재생성되면 그 뒤를 따르는 레이어들은 수정이 없었더라도 캐시를 활용하지 못하고 재생성된다는 점이다. 겹겹이 쌓아가는 레이어의 어느 부분이 변경되면 그 위에 올라가는 레이어도 새롭게 만들어서 쌓아야한다는 의미이다.</p> <h2 id="reference"> <a href="#reference" class="anchor-head"></a> Reference </h2> <ul> <li>https://brianchristner.io/docker-image-base-os-size-comparison/</li> <li>https://medium.com/@ievgen.degtiarenko/reduce-size-of-docker-image-with-spring-boot-application-2b3632263350</li> <li>https://perfectacle.github.io/2019/04/16/spring-boot-docker-image-optimization/</li> <li>https://bcho.tistory.com/1356</li> <li>https://bcho.tistory.com/1357</li> <li>https://spring.io/guides/gs/spring-boot-docker/</li> </ul> </div> </article> </main> <nav class="post-nav"> <a class="post-nav-item post-nav-prev" href="/%EB%8F%84%EC%BB%A4-%EC%9D%B4%EB%AF%B8%EC%A7%80-%EC%83%9D%EC%84%B1-%EA%B0%80%EC%9D%B4%EB%93%9C/" > <div class="nav-arrow">Previous</div> <span class="post-title">도커 이미지 생성 가이드</span> </a> <a class="post-nav-item post-nav-next" href="/%EC%B9%B4%ED%94%84%EC%B9%B4-%EB%94%94%EC%9E%90%EC%9D%B8/"> <div class="nav-arrow">Next</div> <span class="post-title">카프카 디자인</span> </a> </nav> <footer class="footer"> <!--<a class="footer_item" href="/thanks">ack.</a> <a class="footer_item" href="javascript::void(0)">resume</a>--> <a class="footer_item" href="/feed.xml">rss</a> <span class="footer_item">&copy; 2022</span> <small class="footer_copyright"> <!-- Klisé Theme: https://github.com/piharpi/jekyll-klise --> <a href="https://github.com/piharpi/jekyll-klise" target="_blank" rel="noreferrer noopener" >klisé</a > theme on <a href="https://jekyllrb.com" target="_blank" rel="noreferrer noopener" >jekyll</a > </small> </footer> <script src="/assets/js/main.js" defer="defer"></script> </div> </body> </html>
