<!DOCTYPE html> <html lang="en-US"> <head prefix="og: http://ogp.me/ns#"> <meta charset="UTF-8" /> <meta http-equiv="X-UA-Compatible" content="ie=edge" /> <meta name="viewport" content="width=device-width, initial-scale=1.0" /> <meta name="mobile-web-app-capable" content="yes" /> <meta name="apple-mobile-web-app-capable" content="yes" /> <meta name="application-name" content="Ohjongsung's Dev Story" /> <meta name="apple-mobile-web-app-status-bar-style" content="#fff" /> <meta name="apple-mobile-web-app-title" content="Ohjongsung's Dev Story" /> <title> Nosql에서 스키마 변경과 마이그레이션 - Ohjongsung's Dev Story </title> <link rel="alternate" href="http://localhost:4000/NoSQL%EC%97%90%EC%84%9C-%EC%8A%A4%ED%82%A4%EB%A7%88-%EB%B3%80%EA%B2%BD%EA%B3%BC-%EB%A7%88%EC%9D%B4%EA%B7%B8%EB%A0%88%EC%9D%B4%EC%85%98/" hreflang="en-US" /> <link rel="canonical" href="http://localhost:4000/NoSQL%EC%97%90%EC%84%9C-%EC%8A%A4%ED%82%A4%EB%A7%88-%EB%B3%80%EA%B2%BD%EA%B3%BC-%EB%A7%88%EC%9D%B4%EA%B7%B8%EB%A0%88%EC%9D%B4%EC%85%98/" /> <meta name="description" content="개발 블로그입니다. @github." /> <meta name="referrer" content="no-referrer-when-downgrade" /> <meta property="fb:app_id" content="" /> <meta property="og:site_name" content="Nosql에서 스키마 변경과 마이그레이션 | Ohjongsung's Dev Story" /> <meta property="og:title" content="Nosql에서 스키마 변경과 마이그레이션 | Ohjongsung's Dev Story" /> <meta property="og:type" content="website" /> <meta property="og:url" content="http://localhost:4000/NoSQL%EC%97%90%EC%84%9C-%EC%8A%A4%ED%82%A4%EB%A7%88-%EB%B3%80%EA%B2%BD%EA%B3%BC-%EB%A7%88%EC%9D%B4%EA%B7%B8%EB%A0%88%EC%9D%B4%EC%85%98/" /> <meta property="og:description" content="개발 블로그입니다. @github." /> <meta property="og:image" content="http://localhost:4000/assets/img/ogp.png" /> <meta property="og:image:width" content="640" /> <meta property="og:image:height" content="640" /> <meta name="twitter:card" content="summary" /> <meta name="twitter:title" content="Nosql에서 스키마 변경과 마이그레이션 | " /> <meta name="twitter:url" content="http://localhost:4000/NoSQL%EC%97%90%EC%84%9C-%EC%8A%A4%ED%82%A4%EB%A7%88-%EB%B3%80%EA%B2%BD%EA%B3%BC-%EB%A7%88%EC%9D%B4%EA%B7%B8%EB%A0%88%EC%9D%B4%EC%85%98/" /> <meta name="twitter:site" content="@" /> <meta name="twitter:creator" content="@" /> <meta name="twitter:description" content="개발 블로그입니다. @github." /> <meta name="twitter:image" content="http://localhost:4000/assets/img/ogp.png" /> <link type="application/atom+xml" rel="alternate" href="http://localhost:4000/feed.xml" title="Ohjongsung's Dev Story" /> <link rel="apple-touch-icon" sizes="180x180" href="/assets/favicons/apple-touch-icon.png" /> <link rel="icon" type="image/png" sizes="32x32" href="/assets/favicons/favicon-32x32.png" /> <link rel="icon" type="image/png" sizes="16x16" href="/assets/favicons/favicon-16x16.png" /> <link rel="manifest" href="/assets/favicons/site.webmanifest" /> <link rel="mask-icon" href="/assets/favicons/safari-pinned-tab.svg" color="#5bbad5" /> <meta name="apple-mobile-web-app-title" content="Jekyll Klise" /> <meta name="application-name" content="Jekyll Klise" /> <meta name="msapplication-TileColor" content="#da532c" /> <meta name="theme-color" content="#2c2c2c" /> <link rel="stylesheet" href="/assets/css/style.css" /> </head> <body data-theme="light" class="notransition"> <script> const body = document.body; const data = body.getAttribute("data-theme"); const initTheme = (state) => { if (state === "dark") { body.setAttribute("data-theme", "dark"); } else if (state === "light") { body.removeAttribute("data-theme"); } else { localStorage.setItem("theme", data); } }; initTheme(localStorage.getItem("theme")); setTimeout(() => body.classList.remove("notransition"), 75); </script> <div class="navbar" role="navigation"> <nav class="menu"> <input type="checkbox" id="menu-trigger" class="menu-trigger" /> <label for="menu-trigger"> <span class="menu-icon"> <svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 512 512" > <path d="M64,384H448V341.33H64Zm0-106.67H448V234.67H64ZM64,128v42.67H448V128Z" /> </svg> </span> </label> <a id="mode"> <svg class="mode-sunny" xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 512 512" > <title>LIGHT</title> <line x1="256" y1="48" x2="256" y2="96" style="stroke-linecap:round;stroke-miterlimit:10;stroke-width:32px" /> <line x1="256" y1="416" x2="256" y2="464" style="stroke-linecap:round;stroke-miterlimit:10;stroke-width:32px" /> <line x1="403.08" y1="108.92" x2="369.14" y2="142.86" style="stroke-linecap:round;stroke-miterlimit:10;stroke-width:32px" /> <line x1="142.86" y1="369.14" x2="108.92" y2="403.08" style="stroke-linecap:round;stroke-miterlimit:10;stroke-width:32px" /> <line x1="464" y1="256" x2="416" y2="256" style="stroke-linecap:round;stroke-miterlimit:10;stroke-width:32px" /> <line x1="96" y1="256" x2="48" y2="256" style="stroke-linecap:round;stroke-miterlimit:10;stroke-width:32px" /> <line x1="403.08" y1="403.08" x2="369.14" y2="369.14" style="stroke-linecap:round;stroke-miterlimit:10;stroke-width:32px" /> <line x1="142.86" y1="142.86" x2="108.92" y2="108.92" style="stroke-linecap:round;stroke-miterlimit:10;stroke-width:32px" /> <circle cx="256" cy="256" r="80" style="stroke-linecap:round;stroke-miterlimit:10;stroke-width:32px" /> </svg> <svg class="mode-moon" xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 512 512" > <title>DARK</title> <line x1="256" y1="48" x2="256" y2="96" style="stroke-linecap:round;stroke-miterlimit:10;stroke-width:32px" /> <line x1="256" y1="416" x2="256" y2="464" style="stroke-linecap:round;stroke-miterlimit:10;stroke-width:32px" /> <line x1="403.08" y1="108.92" x2="369.14" y2="142.86" style="stroke-linecap:round;stroke-miterlimit:10;stroke-width:32px" /> <line x1="142.86" y1="369.14" x2="108.92" y2="403.08" style="stroke-linecap:round;stroke-miterlimit:10;stroke-width:32px" /> <line x1="464" y1="256" x2="416" y2="256" style="stroke-linecap:round;stroke-miterlimit:10;stroke-width:32px" /> <line x1="96" y1="256" x2="48" y2="256" style="stroke-linecap:round;stroke-miterlimit:10;stroke-width:32px" /> <line x1="403.08" y1="403.08" x2="369.14" y2="369.14" style="stroke-linecap:round;stroke-miterlimit:10;stroke-width:32px" /> <line x1="142.86" y1="142.86" x2="108.92" y2="108.92" style="stroke-linecap:round;stroke-miterlimit:10;stroke-width:32px" /> <circle cx="256" cy="256" r="80" style="stroke-linecap:round;stroke-miterlimit:10;stroke-width:32px" /> </svg> </a> <div class="trigger"> <div class="trigger-container"><a class="menu-link" href="/">home</a><a class="menu-link" href="/archive/">archive</a><a class="menu-link" href="https://github.com/ohjongsung" target="_blank" rel="noopener" >github</a ><a class="menu-link rss" href="/feed.xml"> <svg xmlns="http://www.w3.org/2000/svg" width="17" height="17" viewBox="0 0 512 512" fill="#ED812E" > <title>RSS</title> <path d="M108.56,342.78a60.34,60.34,0,1,0,60.56,60.44A60.63,60.63,0,0,0,108.56,342.78Z" /> <path d="M48,186.67v86.55c52,0,101.94,15.39,138.67,52.11s52,86.56,52,138.67h86.66C325.33,312.44,199.67,186.67,48,186.67Z" /> <path d="M48,48v86.56c185.25,0,329.22,144.08,329.22,329.44H464C464,234.66,277.67,48,48,48Z" /> </svg> </a> </div> </div> </nav> </div> <div class="wrapper post"> <main class="page-content" aria-label="Content"> <article itemscope itemtype="https://schema.org/BlogPosting"> <header class="header"> <h1 class="header-title" itemprop="headline">Nosql에서 스키마 변경과 마이그레이션</h1> <div class="post-meta"> <time datetime="2019-03-01T00:00:00+09:00" itemprop="datePublished"> 2019-03-01 </time> <span itemprop="author" itemscope itemtype="https://schema.org/Person"> <span itemprop="name">Ohjongsung's Dev Story</span> </span> <time hidden datetime="" itemprop="dateModified"> Mar 01, 2019 </time> <span hidden itemprop="publisher" itemtype="Person">Ohjongsung's Dev Story</span> <span hidden itemprop="image"></span> <span hidden itemprop="mainEntityOfPage"><p>NoSQL에서 스키마를 변경한 경우, 모든 문서를 건 바이 건으로 변경된 스키마를 반영한다고 생각해보자. 저장된 데이터의 양이 작다면 순식간에 끝날 것이다. 그러나 데이터의 양이 많아서 며칠이 걸린다면? 중간에 에러가 발생해서 중단되면? 스키마 마이그레이션 작업의 부하가 크다면 어떻게 해야 할까? 이 글을 통해서 NoSQL의 스키마 변경을 어떻게 반영하는지 알아보자.</p> </span> </div> </header> <div class="page-content" itemprop="articleBody"> <p>NoSQL에서 스키마를 변경한 경우, 모든 문서를 건 바이 건으로 변경된 스키마를 반영한다고 생각해보자. 저장된 데이터의 양이 작다면 순식간에 끝날 것이다. 그러나 데이터의 양이 많아서 며칠이 걸린다면? 중간에 에러가 발생해서 중단되면? 스키마 마이그레이션 작업의 부하가 크다면 어떻게 해야 할까? 이 글을 통해서 NoSQL의 스키마 변경을 어떻게 반영하는지 알아보자.</p> <h2 id="schemaless"> <a href="#schemaless" class="anchor-head"></a> Schemaless </h2> <p>NoSQL의 특성 중 하나인 이 말은 스키마가 없다는 것이 아니라, RDB의 스키마보다 유연하고 탄력적인 스키마를 뜻한다. RDB에서는 ALTER 쿼리를 사용해서 스키마를 변경한다. 그리고 쿼리를 실행하면 Row가 아무리 많아도 동시에 변경된다. ACID 트랜잭션 덕분에 쿼리 실행이 실패하면 그 어떤 행에도 스키마가 변경되지 않고, 어설프게 반영되는 일은 없다. 반대로 NoSQL에서는 따로 스키마를 관리하는 포인트가 없다. 그저 Application에 정의한 Entity가 스키마고, 여기에 필드를 추가하거나 변경하면 새로 입력된 데이터는 변경된 스키마가 반영되어 저장된다.</p> <h4 id="rdb에서-스키마-변경"> <a href="#rdb에서-스키마-변경" class="anchor-head"></a> RDB에서 스키마 변경 </h4> <div class="language-sql highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="k">ALTER</span> <span class="k">TABLE</span> <span class="n">Products</span> <span class="k">ADD</span> <span class="n">description</span> <span class="nb">VARCHAR</span><span class="p">(</span><span class="mi">250</span><span class="p">)</span> <span class="k">NOT</span> <span class="k">NULL</span> <span class="k">DEFAULT</span><span class="p">(</span><span class="nv">"소개글"</span><span class="p">);</span>
</code></pre></div></div> <h4 id="nosql에서-스키마-변경"> <a href="#nosql에서-스키마-변경" class="anchor-head"></a> NoSQL에서 스키마 변경 </h4> <div class="language-java highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="kd">public</span> <span class="kd">class</span> <span class="nc">Product</span><span class="o">{</span>
	<span class="kd">private</span> <span class="kt">long</span> <span class="n">productId</span><span class="o">;</span>
	<span class="kd">private</span> <span class="nc">String</span> <span class="n">name</span><span class="o">;</span>
	<span class="kd">private</span> <span class="kt">long</span> <span class="n">price</span><span class="o">;</span>
	<span class="c1">// description field를 추가하자.</span>
	<span class="kd">private</span> <span class="nc">String</span> <span class="n">description</span><span class="o">;</span>
<span class="o">}</span>
</code></pre></div></div> <p>스키마가 RDB처럼 Database에 정의하는 것이 아니라, Application에 정의한다고 생각하면 편하다. 그런데 RDB를 다루던 습관때문인지 NoSQL에서 스키마를 변경하게 되면, 변경 사항을 이미 저장된 문서에 반영하고 싶어 진다. NoSQL은 스키마가 다른 여러 문서도 수용하는데 말이다.</p> <h2 id="다양한-스키마-지원"> <a href="#다양한-스키마-지원" class="anchor-head"></a> 다양한 스키마 지원 </h2> <p>NoSQL은 스키마가 다른 여러 문서도 수용할 수 있다. 그렇다면, 굳이 스키마를 RDB처럼 하나의 스키마로 유지하려고 애쓰지 말자. 어떤 스키마로 저장되어 있든, Application단에서 메모리에 올라갈때, 최신 버전의 스키마로 데이터를 변환해주면 된다.</p> <p>기존 데이터는 Entity version 1로 다음과 같이 저장되어 있다고 하자.</p> <div class="language-java highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="kd">public</span> <span class="kd">class</span> <span class="nc">Product</span><span class="o">{</span>
	<span class="kd">private</span> <span class="kt">int</span> <span class="n">version</span> <span class="o">=</span> <span class="mi">1</span><span class="o">;</span>
	<span class="kd">private</span> <span class="nc">String</span> <span class="n">name</span><span class="o">;</span>
	<span class="kd">private</span> <span class="kt">long</span> <span class="n">productId</span><span class="o">;</span>
	<span class="kd">private</span> <span class="kt">long</span> <span class="n">price</span><span class="o">;</span>
<span class="o">}</span>

<span class="err">```</span><span class="n">json</span>
<span class="o">{</span>
    <span class="nl">_productId:</span> <span class="mi">123</span><span class="o">,</span>
   <span class="nl">name:</span> <span class="s">"CouchBase"</span>
    <span class="nl">version:</span> <span class="mi">1</span><span class="o">,</span>
    <span class="nl">price:</span> <span class="mi">1000</span>
<span class="o">},</span>
<span class="o">{</span>
    <span class="nl">_productId:</span> <span class="mi">125</span><span class="o">,</span>
    <span class="nl">name:</span> <span class="s">"Hbase"</span>
    <span class="nl">version:</span> <span class="mi">1</span><span class="o">,</span>
    <span class="nl">price:</span> <span class="mi">1200</span>
<span class="o">}</span>
</code></pre></div></div> <p>그리고 description 필드를 추가하면서 Entity version을 2로 변경해서 저장하기 시작했다.</p> <div class="language-java highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="kd">public</span> <span class="kd">class</span> <span class="nc">Product</span><span class="o">{</span>
	<span class="kd">private</span> <span class="kt">int</span> <span class="n">version</span> <span class="o">=</span> <span class="mi">2</span><span class="o">;</span>
       <span class="kd">private</span> <span class="nc">String</span> <span class="n">name</span><span class="o">;</span>
	<span class="kd">private</span> <span class="kt">long</span> <span class="n">productId</span><span class="o">;</span>
	<span class="kd">private</span> <span class="kt">long</span> <span class="n">price</span><span class="o">;</span>
	<span class="kd">private</span> <span class="nc">String</span> <span class="n">description</span><span class="o">;</span>
<span class="o">}</span>
</code></pre></div></div> <div class="language-json highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="p">{</span><span class="w">
    </span><span class="err">_productId:</span><span class="w"> </span><span class="mi">127</span><span class="p">,</span><span class="w">
    </span><span class="err">name:</span><span class="w"> </span><span class="s2">"MongoDB"</span><span class="w">
    </span><span class="err">version:</span><span class="w"> </span><span class="mi">2</span><span class="p">,</span><span class="w">
    </span><span class="err">price:</span><span class="w"> </span><span class="mi">1500</span><span class="p">,</span><span class="w">
    </span><span class="err">description:</span><span class="w"> </span><span class="s2">"Document Database"</span><span class="w">
</span><span class="p">}</span><span class="w">
</span></code></pre></div></div> <p>그리고 version이 0 에서 1로 올라갈때, 데이터 마이그레이션 함수를 만들어 두자. 이 함수는 문서를 Application에서 읽을 때 저장된 버전이 최신 버전과 다를때 실행된다.</p> <div class="language-java highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="kd">public</span> <span class="nc">Product</span> <span class="nf">getProduct</span><span class="o">(</span><span class="kt">long</span> <span class="n">productId</span><span class="o">){</span>
	<span class="nc">JsonDocument</span> <span class="n">doc</span> <span class="o">=</span> <span class="n">nosqlRepository</span><span class="o">.</span><span class="na">get</span><span class="o">(</span><span class="n">productId</span><span class="o">);</span>
	<span class="nc">Product</span> <span class="n">product</span> <span class="o">=</span> <span class="n">defaultConvertDocument</span><span class="o">(</span><span class="n">doc</span><span class="o">);</span>
	<span class="k">if</span> <span class="o">(</span><span class="n">doc</span><span class="o">[</span><span class="err">'</span><span class="n">version</span><span class="err">'</span><span class="o">]</span> <span class="o">!=</span> <span class="n">product</span><span class="o">.</span><span class="na">getVersion</span><span class="o">()){</span>
		<span class="k">return</span> <span class="nf">migrateOneToTwo</span><span class="o">(</span><span class="n">product</span><span class="o">);</span>
	<span class="o">}</span>
<span class="o">}</span>

<span class="kd">public</span> <span class="kt">void</span> <span class="nf">migrateOneToTwo</span><span class="o">(</span><span class="nc">Product</span> <span class="n">product</span><span class="o">)</span> <span class="o">{</span>
	<span class="n">product</span><span class="o">.</span><span class="na">setDescription</span><span class="o">(</span><span class="s">"NoSQL Database"</span><span class="o">);</span>
	<span class="c1">// 필요할 경우 저장도 하자.</span>
	<span class="c1">// nosqlRepository.save(product);</span>
	<span class="k">return</span> <span class="n">product</span><span class="o">;</span>
<span class="o">}</span>
</code></pre></div></div> <p>이렇게 작업을 하면, 데이터가 호출될때는 무조건 최신 스키마가 반영된 데이터를 확인 할 수 있게 된다. 그리고 마이그레이션 작업의 부하가 분산되는 효과도 얻을 수 있다. 따지고 보면, 우리가 데이터 포멧 변경하기 위한 코드와 크게 다르지 않다. 그리고 이런 방법을 on-demand migration이라고 한다.</p> <h2 id="마무리"> <a href="#마무리" class="anchor-head"></a> 마무리 </h2> <p>설명한 방식이 제대로 작동하려면 데이터의 접근이 꼭 앞서 보여준 코드의 getProduct 메서드를 통해야 한다는 것이다. 누군가 새로운 클라이언트를 만들어 데이터에 접근한다면, 문제가 발생할 수 있다. 그리고 NoSQL에서 지원하는 쿼리 기능을 사용할 경우, 변경된 스키마 내용이 쿼리 조건에 들어가거나 인덱싱되어야 한다면 의미가 없어진다. 건 바이 건으로 전체 마이그레이션을 해줘야 한다. 그런데 이런 경우가 많다면 NoSQL을 사용할게 아니라 RDB로 가야하는 거 아닐까? NoSQL 사용이 서비스 목적에 맞는지 생각해 볼 일이다.</p> <h2 id="reference"> <a href="#reference" class="anchor-head"></a> Reference </h2> <ul> <li>https://stackoverflow.com/questions/13473123/what-are-good-approaches-for-migrating-data-format-in-schemaless-databases</li> <li>https://stackoverflow.com/questions/49330096/schema-migration-scripts-in-nosql-databases</li> <li>http://mongodb.github.io/mongo-csharp-driver/2.3/reference/bson/mapping/schema_changes/</li> <li>https://www.slideshare.net/hoyoungchoi980/nosql-mmorpg</li> </ul> </div> </article> </main> <nav class="post-nav"> <a class="post-nav-item post-nav-prev" href="/Windows-10-Pro-%EC%97%90-Docker-%EC%99%80-Mysql-%EC%84%A4%EC%B9%98/" > <div class="nav-arrow">Previous</div> <span class="post-title">Windows 10 Pro 에 Docker 와 Mysql 설치</span> </a> <a class="post-nav-item post-nav-next" href="/CAP-%EC%9D%B4%EB%A1%A0%EA%B3%BC-PACELC-%EC%9D%B4%EB%A1%A0/"> <div class="nav-arrow">Next</div> <span class="post-title">Cap 이론과 Pacelc 이론</span> </a> </nav> <footer class="footer"> <!--<a class="footer_item" href="/thanks">ack.</a> <a class="footer_item" href="javascript::void(0)">resume</a>--> <a class="footer_item" href="/feed.xml">rss</a> <span class="footer_item">&copy; 2022</span> <small class="footer_copyright"> <!-- Klisé Theme: https://github.com/piharpi/jekyll-klise --> <a href="https://github.com/piharpi/jekyll-klise" target="_blank" rel="noreferrer noopener" >klisé</a > theme on <a href="https://jekyllrb.com" target="_blank" rel="noreferrer noopener" >jekyll</a > </small> </footer> <script src="/assets/js/main.js" defer="defer"></script> </div> </body> </html>
