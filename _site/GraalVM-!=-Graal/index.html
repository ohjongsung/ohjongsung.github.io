<!DOCTYPE html> <html lang="en-US"> <head prefix="og: http://ogp.me/ns#"> <meta charset="UTF-8" /> <meta http-equiv="X-UA-Compatible" content="ie=edge" /> <meta name="viewport" content="width=device-width, initial-scale=1.0" /> <meta name="mobile-web-app-capable" content="yes" /> <meta name="apple-mobile-web-app-capable" content="yes" /> <meta name="application-name" content="Ohjongsung's Dev Story" /> <meta name="apple-mobile-web-app-status-bar-style" content="#fff" /> <meta name="apple-mobile-web-app-title" content="Ohjongsung's Dev Story" /> <title> Graalvm != Graal - Ohjongsung's Dev Story </title> <link rel="alternate" href="http://localhost:4000/GraalVM-!=-Graal/" hreflang="en-US" /> <link rel="canonical" href="http://localhost:4000/GraalVM-!=-Graal/" /> <meta name="description" content="개발 블로그입니다. @github." /> <meta name="referrer" content="no-referrer-when-downgrade" /> <meta property="fb:app_id" content="" /> <meta property="og:site_name" content="Graalvm != Graal | Ohjongsung's Dev Story" /> <meta property="og:title" content="Graalvm != Graal | Ohjongsung's Dev Story" /> <meta property="og:type" content="website" /> <meta property="og:url" content="http://localhost:4000/GraalVM-!=-Graal/" /> <meta property="og:description" content="개발 블로그입니다. @github." /> <meta property="og:image" content="http://localhost:4000/assets/img/ogp.png" /> <meta property="og:image:width" content="640" /> <meta property="og:image:height" content="640" /> <meta name="twitter:card" content="summary" /> <meta name="twitter:title" content="Graalvm != Graal | " /> <meta name="twitter:url" content="http://localhost:4000/GraalVM-!=-Graal/" /> <meta name="twitter:site" content="@" /> <meta name="twitter:creator" content="@" /> <meta name="twitter:description" content="개발 블로그입니다. @github." /> <meta name="twitter:image" content="http://localhost:4000/assets/img/ogp.png" /> <link type="application/atom+xml" rel="alternate" href="http://localhost:4000/feed.xml" title="Ohjongsung's Dev Story" /> <link rel="apple-touch-icon" sizes="180x180" href="/assets/favicons/apple-touch-icon.png" /> <link rel="icon" type="image/png" sizes="32x32" href="/assets/favicons/favicon-32x32.png" /> <link rel="icon" type="image/png" sizes="16x16" href="/assets/favicons/favicon-16x16.png" /> <link rel="manifest" href="/assets/favicons/site.webmanifest" /> <link rel="mask-icon" href="/assets/favicons/safari-pinned-tab.svg" color="#5bbad5" /> <meta name="apple-mobile-web-app-title" content="Jekyll Klise" /> <meta name="application-name" content="Jekyll Klise" /> <meta name="msapplication-TileColor" content="#da532c" /> <meta name="theme-color" content="#2c2c2c" /> <link rel="stylesheet" href="/assets/css/style.css" /> </head> <body data-theme="light" class="notransition"> <script> const body = document.body; const data = body.getAttribute("data-theme"); const initTheme = (state) => { if (state === "dark") { body.setAttribute("data-theme", "dark"); } else if (state === "light") { body.removeAttribute("data-theme"); } else { localStorage.setItem("theme", data); } }; initTheme(localStorage.getItem("theme")); setTimeout(() => body.classList.remove("notransition"), 75); </script> <div class="navbar" role="navigation"> <nav class="menu"> <input type="checkbox" id="menu-trigger" class="menu-trigger" /> <label for="menu-trigger"> <span class="menu-icon"> <svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 512 512" > <path d="M64,384H448V341.33H64Zm0-106.67H448V234.67H64ZM64,128v42.67H448V128Z" /> </svg> </span> </label> <a id="mode"> <svg class="mode-sunny" xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 512 512" > <title>LIGHT</title> <line x1="256" y1="48" x2="256" y2="96" style="stroke-linecap:round;stroke-miterlimit:10;stroke-width:32px" /> <line x1="256" y1="416" x2="256" y2="464" style="stroke-linecap:round;stroke-miterlimit:10;stroke-width:32px" /> <line x1="403.08" y1="108.92" x2="369.14" y2="142.86" style="stroke-linecap:round;stroke-miterlimit:10;stroke-width:32px" /> <line x1="142.86" y1="369.14" x2="108.92" y2="403.08" style="stroke-linecap:round;stroke-miterlimit:10;stroke-width:32px" /> <line x1="464" y1="256" x2="416" y2="256" style="stroke-linecap:round;stroke-miterlimit:10;stroke-width:32px" /> <line x1="96" y1="256" x2="48" y2="256" style="stroke-linecap:round;stroke-miterlimit:10;stroke-width:32px" /> <line x1="403.08" y1="403.08" x2="369.14" y2="369.14" style="stroke-linecap:round;stroke-miterlimit:10;stroke-width:32px" /> <line x1="142.86" y1="142.86" x2="108.92" y2="108.92" style="stroke-linecap:round;stroke-miterlimit:10;stroke-width:32px" /> <circle cx="256" cy="256" r="80" style="stroke-linecap:round;stroke-miterlimit:10;stroke-width:32px" /> </svg> <svg class="mode-moon" xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 512 512" > <title>DARK</title> <line x1="256" y1="48" x2="256" y2="96" style="stroke-linecap:round;stroke-miterlimit:10;stroke-width:32px" /> <line x1="256" y1="416" x2="256" y2="464" style="stroke-linecap:round;stroke-miterlimit:10;stroke-width:32px" /> <line x1="403.08" y1="108.92" x2="369.14" y2="142.86" style="stroke-linecap:round;stroke-miterlimit:10;stroke-width:32px" /> <line x1="142.86" y1="369.14" x2="108.92" y2="403.08" style="stroke-linecap:round;stroke-miterlimit:10;stroke-width:32px" /> <line x1="464" y1="256" x2="416" y2="256" style="stroke-linecap:round;stroke-miterlimit:10;stroke-width:32px" /> <line x1="96" y1="256" x2="48" y2="256" style="stroke-linecap:round;stroke-miterlimit:10;stroke-width:32px" /> <line x1="403.08" y1="403.08" x2="369.14" y2="369.14" style="stroke-linecap:round;stroke-miterlimit:10;stroke-width:32px" /> <line x1="142.86" y1="142.86" x2="108.92" y2="108.92" style="stroke-linecap:round;stroke-miterlimit:10;stroke-width:32px" /> <circle cx="256" cy="256" r="80" style="stroke-linecap:round;stroke-miterlimit:10;stroke-width:32px" /> </svg> </a> <div class="trigger"> <div class="trigger-container"><a class="menu-link" href="/">home</a><a class="menu-link" href="/archive/">archive</a><a class="menu-link" href="https://github.com/ohjongsung" target="_blank" rel="noopener" >github</a ><a class="menu-link rss" href="/feed.xml"> <svg xmlns="http://www.w3.org/2000/svg" width="17" height="17" viewBox="0 0 512 512" fill="#ED812E" > <title>RSS</title> <path d="M108.56,342.78a60.34,60.34,0,1,0,60.56,60.44A60.63,60.63,0,0,0,108.56,342.78Z" /> <path d="M48,186.67v86.55c52,0,101.94,15.39,138.67,52.11s52,86.56,52,138.67h86.66C325.33,312.44,199.67,186.67,48,186.67Z" /> <path d="M48,48v86.56c185.25,0,329.22,144.08,329.22,329.44H464C464,234.66,277.67,48,48,48Z" /> </svg> </a> </div> </div> </nav> </div> <div class="wrapper post"> <main class="page-content" aria-label="Content"> <article itemscope itemtype="https://schema.org/BlogPosting"> <header class="header"> <h1 class="header-title" itemprop="headline">Graalvm != Graal</h1> <div class="post-meta"> <time datetime="2019-12-08T00:00:00+09:00" itemprop="datePublished"> 2019-12-08 </time> <span itemprop="author" itemscope itemtype="https://schema.org/Person"> <span itemprop="name">Ohjongsung's Dev Story</span> </span> <time hidden datetime="" itemprop="dateModified"> Dec 08, 2019 </time> <span hidden itemprop="publisher" itemtype="Person">Ohjongsung's Dev Story</span> <span hidden itemprop="image"></span> <span hidden itemprop="mainEntityOfPage"><p>meta-circular 스타일이란 언어를 실행하는 환경과 코드를 개발하는 언어가 같은 스타일을 의미한다. C++로 개발된 HotSpot 은 지난 20년동안 자바 성능을 크게 끌어올렸지만, C++ 코드가 너무 복잡해진 나머지 추가적인 성능 개선이 어려운 상황이다. 그 대안으로 R&amp;D로 개발해온 Maxine VM 이 추구하던 Meta-Circular 자바의 구현체가 바로 GraalVM 이다.</p> </span> </div> </header> <div class="page-content" itemprop="articleBody"> <p>meta-circular 스타일이란 언어를 실행하는 환경과 코드를 개발하는 언어가 같은 스타일을 의미한다. C++로 개발된 HotSpot 은 지난 20년동안 자바 성능을 크게 끌어올렸지만, C++ 코드가 너무 복잡해진 나머지 추가적인 성능 개선이 어려운 상황이다. 그 대안으로 R&amp;D로 개발해온 Maxine VM 이 추구하던 Meta-Circular 자바의 구현체가 바로 GraalVM 이다.</p> <h2 id="graalvm의-3가지-특징"> <a href="#graalvm의-3가지-특징" class="anchor-head"></a> GraalVM의 3가지 특징 </h2> <ol> <li>Graal을 기반으로하는 고성능 자바 = New JIT Compiler</li> <li>Polyglot을 기반으로 다양한 언어의 통합 기능 = Language Platform</li> <li>Native 자바의 빠른 startup time을 제공 = AOT Compiler</li> <li><strong>클라우드와 Docker/Kubernetes 환경에 적합한 기능</strong></li> </ol> <h2 id="graalvm-개발-사이클"> <a href="#graalvm-개발-사이클" class="anchor-head"></a> GraalVM 개발 사이클 </h2> <p><img src="devcycle.png" alt="devcycle" /></p> <p>GraalVM의 JVMCI, AOT, Graal JIT이 위 그림과 같이 새로운 기법을 JEP-243, JEP-295, JEP-317로 정의하여 OpenJDK에 적용하고 있다. GraalVM에서 개발되고 검증된 이러한 기술은 OpenJDK에 적용되어 표준 자바에 추가된다. 그리고 OpenJDK에 적용된 기술은 결과적으로 Oracle Java에 반영된다.</p> <h2 id="graalvm의-의미"> <a href="#graalvm의-의미" class="anchor-head"></a> GraalVM의 의미 </h2> <ol> <li>자바 신기술 개발과 검증의 시작점: 새로운 개념과 기술을 적용하는 자바 확장 및 실험 환경</li> <li>신기술에 대한 피드백 창고: 오픈소스와 GraalVM Communtiy Edition을 통한 활발한 피드백 수집과 개선</li> <li>고성능 자바: Graal JIT 컴파일러와 메모리 구조</li> <li>Native 특징을 이용한 효율적인 임베디드 자바</li> </ol> <h2 id="graal"> <a href="#graal" class="anchor-head"></a> Graal </h2> <p>GraalVM 이 Hotspot 전체를 java 로 작성한 것을 뜻하지 않는다. C2 컴파일러와 HotspotVM 과 통신하는 컴파일러 인터페이스 부분을 java로 다시 작성된 부분이 포함된 것을 GraalVM 이라고 한다.</p> <p><img src="hotspotvm.jpg" alt="hotspotvm" /></p> <p>여기서 C2 컴파일러를 Graal 이라고 말한다. 가끔 GraalVM 과 Graal 을 똑같은 의미로 생각하는 사람들이 있는데, 그렇지 않다.</p> <p><img src="graalvm.jpg" alt="graalvm" /></p> <h2 id="graal-의-성능"> <a href="#graal-의-성능" class="anchor-head"></a> Graal 의 성능 </h2> <p><a href="https://www.slideshare.net/jyukutyo/graal-in-graalvm-a-new-jit-compiler">공식 문서</a>에 나와있는 성능 실험을 살펴보면 아래의 코드를 작성하고,</p> <div class="language-java highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="kd">public</span> <span class="kd">class</span> <span class="nc">CountUppercase</span> <span class="o">{</span>
    <span class="kd">static</span> <span class="kd">final</span> <span class="kt">int</span> <span class="no">ITERATIONS</span> <span class="o">=</span> <span class="nc">Math</span><span class="o">.</span><span class="na">max</span><span class="o">(</span><span class="nc">Integer</span><span class="o">.</span><span class="na">getInteger</span><span class="o">(</span><span class="s">"iterations"</span><span class="o">,</span> <span class="mi">1</span><span class="o">),</span> <span class="mi">1</span><span class="o">);</span>
    <span class="kd">public</span> <span class="kd">static</span> <span class="kt">void</span> <span class="nf">main</span><span class="o">(</span><span class="nc">String</span><span class="o">[]</span> <span class="n">args</span><span class="o">)</span> <span class="o">{</span>
        <span class="nc">String</span> <span class="n">sentence</span> <span class="o">=</span> <span class="nc">String</span><span class="o">.</span><span class="na">join</span><span class="o">(</span><span class="s">" "</span><span class="o">,</span> <span class="n">args</span><span class="o">);</span>
        <span class="k">for</span> <span class="o">(</span><span class="kt">int</span> <span class="n">iter</span> <span class="o">=</span> <span class="mi">0</span><span class="o">;</span> <span class="n">iter</span> <span class="o">&lt;</span> <span class="no">ITERATIONS</span><span class="o">;</span> <span class="n">iter</span><span class="o">++)</span> <span class="o">{</span>
            <span class="k">if</span> <span class="o">(</span><span class="no">ITERATIONS</span> <span class="o">!=</span> <span class="mi">1</span><span class="o">)</span> <span class="nc">System</span><span class="o">.</span><span class="na">out</span><span class="o">.</span><span class="na">println</span><span class="o">(</span><span class="s">"-- iteration "</span> <span class="o">+</span> <span class="o">(</span><span class="n">iter</span> <span class="o">+</span> <span class="mi">1</span><span class="o">)</span> <span class="o">+</span> <span class="s">" --"</span><span class="o">);</span>
            <span class="kt">long</span> <span class="n">total</span> <span class="o">=</span> <span class="mi">0</span><span class="o">,</span> <span class="n">start</span> <span class="o">=</span> <span class="nc">System</span><span class="o">.</span><span class="na">currentTimeMillis</span><span class="o">(),</span> <span class="n">last</span> <span class="o">=</span> <span class="n">start</span><span class="o">;</span>
            <span class="k">for</span> <span class="o">(</span><span class="kt">int</span> <span class="n">i</span> <span class="o">=</span> <span class="mi">1</span><span class="o">;</span> <span class="n">i</span> <span class="o">&lt;</span> <span class="mi">10_000_000</span><span class="o">;</span> <span class="n">i</span><span class="o">++)</span> <span class="o">{</span>
                <span class="n">total</span> <span class="o">+=</span> <span class="n">sentence</span><span class="o">.</span><span class="na">chars</span><span class="o">().</span><span class="na">filter</span><span class="o">(</span><span class="nl">Character:</span><span class="o">:</span><span class="n">isUpperCase</span><span class="o">).</span><span class="na">count</span><span class="o">();</span>
                <span class="k">if</span> <span class="o">(</span><span class="n">i</span> <span class="o">%</span> <span class="mi">1_000_000</span> <span class="o">==</span> <span class="mi">0</span><span class="o">)</span> <span class="o">{</span>
                    <span class="kt">long</span> <span class="n">now</span> <span class="o">=</span> <span class="nc">System</span><span class="o">.</span><span class="na">currentTimeMillis</span><span class="o">();</span>
                    <span class="nc">System</span><span class="o">.</span><span class="na">out</span><span class="o">.</span><span class="na">printf</span><span class="o">(</span><span class="s">"%d (%d ms)%n"</span><span class="o">,</span> <span class="n">i</span> <span class="o">/</span> <span class="mi">1_000_000</span><span class="o">,</span> <span class="n">now</span> <span class="o">-</span> <span class="n">last</span><span class="o">);</span>
                    <span class="n">last</span> <span class="o">=</span> <span class="n">now</span><span class="o">;</span>
                <span class="o">}</span>
            <span class="o">}</span>
            <span class="nc">System</span><span class="o">.</span><span class="na">out</span><span class="o">.</span><span class="na">printf</span><span class="o">(</span><span class="s">"total: %d (%d ms)%n"</span><span class="o">,</span> <span class="n">total</span><span class="o">,</span> <span class="nc">System</span><span class="o">.</span><span class="na">currentTimeMillis</span><span class="o">()</span> <span class="o">-</span> <span class="n">start</span><span class="o">);</span>
        <span class="o">}</span>
    <span class="o">}</span>
<span class="o">}</span>
</code></pre></div></div> <p>컴파일하고 실행을 해서,</p> <div class="language-java highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="n">javac</span> <span class="nc">CountUppercase</span><span class="o">.</span><span class="na">java</span>
<span class="n">java</span> <span class="o">-</span><span class="nl">XX:</span><span class="o">+</span><span class="nc">UnlockExperimentalVMOptions</span> <span class="o">-</span><span class="nl">XX:</span><span class="o">+</span><span class="nc">EnableJVMCI</span> <span class="o">-</span><span class="nl">XX:</span><span class="o">+</span><span class="nc">UseJVMCICompiler</span>
</code></pre></div></div> <p>결과를 보면,</p> <div class="language-plaintext highlighter-rouge"><div class="highlight"><pre class="highlight"><code>1 (1581 ms)
2 (480 ms)
3 (364 ms)
4 (231 ms)
5 (196 ms)
6 (121 ms)
7 (116 ms)
8 (116 ms)
9 (116 ms)
total: 59999994 (3436 ms)
</code></pre></div></div> <p>워밍업 시간이 제법 걸린다는 것을 알 수 있다. 워밍업 시간은 응용 프로그램의 다중 스레드 개수 또는 VM이 ​​사용하는 스레드 수와 같은 다양한 요소에 따라 달라진다. 코어가 적으면 위밍업 시간이 길어진다. 보다 자세한 Graal 컴파일의 통계(컴파일 된 메소드, 처리 된 시간, 처리 된 바이트 코드 (인라인 된 메소드도 포함), 생성 된 머신 코드의 크기 및 컴파일 중 할당 된 메모리 양)를 보려면 프로그램을 실행할 때 다음 플래그를 추가해야한다.</p> <div class="language-plaintext highlighter-rouge"><div class="highlight"><pre class="highlight"><code>-Dgraal.PrintCompilation=true
</code></pre></div></div> <p>-XX : -UseJVMCICompiler 옵션을 사용하여 GraalVM 컴파일러를 사용하지 않도록 설정하고 VM에서 기본 C2 컴파일러를 사용하여 성능을 비교해보자.</p> <div class="language-java highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="n">javac</span> <span class="nc">CountUppercase</span><span class="o">.</span><span class="na">java</span>
<span class="n">java</span> <span class="o">-</span><span class="nl">XX:</span><span class="o">+</span><span class="nc">UnlockExperimentalVMOptions</span> <span class="o">-</span><span class="nl">XX:</span><span class="o">+</span><span class="nc">EnableJVMCI</span> <span class="o">-</span><span class="nl">XX:</span><span class="o">-</span><span class="nc">UseJVMCICompiler</span>
</code></pre></div></div> <p>결과를 보면,</p> <div class="language-plaintext highlighter-rouge"><div class="highlight"><pre class="highlight"><code>1 (602 ms)
2 (443 ms)
3 (429 ms)
4 (423 ms)
5 (418 ms)
6 (432 ms)
7 (454 ms)
8 (415 ms)
9 (407 ms)
total: 69999993 (4443 ms)
</code></pre></div></div> <p>워밍업 시간은 짧지만, 처음과 끝의 속도차이가 그리 차이나지 않는 것을 볼 수 있다.</p> <h2 id="graal-은-graalvm-에서만-사용가능한가"> <a href="#graal-은-graalvm-에서만-사용가능한가" class="anchor-head"></a> Graal 은 GraalVM 에서만 사용가능한가? </h2> <p>앞서 설명한 개발 사이클을 보면, GraalVM 에 적용된 기능이 openJDK 에도 추가되는 것을 확인했다. JVMCI 는 openJDK 9 에서부터, <img src="jvmci.jpg" alt="jvmci" /></p> <p>Graal 은 openJDK 10 에서부터 사용가능해졌다. <img src="graal.jpg" alt="graal" /></p> <h3 id="java-10-에서-사용법"> <a href="#java-10-에서-사용법" class="anchor-head"></a> JAVA 10 에서 사용법 </h3> <p>앞선 성능에서 이미 보여줬다.</p> <div class="language-java highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="o">-</span><span class="nl">XX:</span><span class="o">+</span><span class="nc">UnlockExperimentalVMOptions</span>  <span class="o">-</span><span class="nl">XX:</span><span class="o">+</span><span class="nc">UseJVMCICompiler</span>
</code></pre></div></div> <h2 id="마무리"> <a href="#마무리" class="anchor-head"></a> 마무리 </h2> <p>Polyglot, AOT Compiler 부분은 생략한다. Polyglot 은 현재 고려할 사항이 아니라서 제외했다. 그리고 <a href="https://github.com/spring-projects/spring-framework/wiki/GraalVM-native-image-support">GraalVM native image</a> 기능은 아직 실험적인 기능으로 운영 레벨에서 사용할 일이 없다. <a href="https://github.com/spring-projects/spring-framework/wiki/GraalVM-native-image-support">스프링</a>에서도 Spring Framework 5.3 에서나 제대로 지원해줄 것 같다.</p> <h2 id="reference"> <a href="#reference" class="anchor-head"></a> Reference </h2> <ul> <li>https://www.slideshare.net/jyukutyo/graal-in-graalvm-a-new-jit-compiler</li> <li>https://www.graalvm.org/docs/examples/java-performance-examples/</li> <li>https://github.com/oracle/graal/blob/master/substratevm/LIMITATIONS.md</li> <li>https://github.com/spring-projects/spring-framework/wiki/GraalVM-native-image-support</li> </ul> </div> </article> </main> <nav class="post-nav"> <a class="post-nav-item post-nav-prev" href="/%EC%B9%B4%ED%94%84%EC%B9%B4-%EB%94%94%EC%9E%90%EC%9D%B8/" > <div class="nav-arrow">Previous</div> <span class="post-title">카프카 디자인</span> </a> <a class="post-nav-item post-nav-next" href="/%EC%B9%B4%ED%94%84%EC%B9%B4-%ED%8A%9C%EB%8B%9D-%EB%B0%A9%EC%95%88-%EC%A0%95%EB%A6%AC/"> <div class="nav-arrow">Next</div> <span class="post-title">카프카 튜닝 방안 정리</span> </a> </nav> <footer class="footer"> <!--<a class="footer_item" href="/thanks">ack.</a> <a class="footer_item" href="javascript::void(0)">resume</a>--> <a class="footer_item" href="/feed.xml">rss</a> <span class="footer_item">&copy; 2022</span> <small class="footer_copyright"> <!-- Klisé Theme: https://github.com/piharpi/jekyll-klise --> <a href="https://github.com/piharpi/jekyll-klise" target="_blank" rel="noreferrer noopener" >klisé</a > theme on <a href="https://jekyllrb.com" target="_blank" rel="noreferrer noopener" >jekyll</a > </small> </footer> <script src="/assets/js/main.js" defer="defer"></script> </div> </body> </html>
