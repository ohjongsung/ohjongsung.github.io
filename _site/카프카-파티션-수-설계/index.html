<!DOCTYPE html> <html lang="en-US"> <head prefix="og: http://ogp.me/ns#"> <meta charset="UTF-8" /> <meta http-equiv="X-UA-Compatible" content="ie=edge" /> <meta name="viewport" content="width=device-width, initial-scale=1.0" /> <meta name="mobile-web-app-capable" content="yes" /> <meta name="apple-mobile-web-app-capable" content="yes" /> <meta name="application-name" content="Ohjongsung's Dev Story" /> <meta name="apple-mobile-web-app-status-bar-style" content="#fff" /> <meta name="apple-mobile-web-app-title" content="Ohjongsung's Dev Story" /> <title> 카프카 파티션 수 설계 - Ohjongsung's Dev Story </title> <link rel="alternate" href="http://localhost:4000/%EC%B9%B4%ED%94%84%EC%B9%B4-%ED%8C%8C%ED%8B%B0%EC%85%98-%EC%88%98-%EC%84%A4%EA%B3%84/" hreflang="en-US" /> <link rel="canonical" href="http://localhost:4000/%EC%B9%B4%ED%94%84%EC%B9%B4-%ED%8C%8C%ED%8B%B0%EC%85%98-%EC%88%98-%EC%84%A4%EA%B3%84/" /> <meta name="description" content="개발 블로그입니다. @github." /> <meta name="referrer" content="no-referrer-when-downgrade" /> <meta property="fb:app_id" content="" /> <meta property="og:site_name" content="카프카 파티션 수 설계 | Ohjongsung's Dev Story" /> <meta property="og:title" content="카프카 파티션 수 설계 | Ohjongsung's Dev Story" /> <meta property="og:type" content="website" /> <meta property="og:url" content="http://localhost:4000/%EC%B9%B4%ED%94%84%EC%B9%B4-%ED%8C%8C%ED%8B%B0%EC%85%98-%EC%88%98-%EC%84%A4%EA%B3%84/" /> <meta property="og:description" content="개발 블로그입니다. @github." /> <meta property="og:image" content="http://localhost:4000/assets/img/ogp.png" /> <meta property="og:image:width" content="640" /> <meta property="og:image:height" content="640" /> <meta name="twitter:card" content="summary" /> <meta name="twitter:title" content="카프카 파티션 수 설계 | " /> <meta name="twitter:url" content="http://localhost:4000/%EC%B9%B4%ED%94%84%EC%B9%B4-%ED%8C%8C%ED%8B%B0%EC%85%98-%EC%88%98-%EC%84%A4%EA%B3%84/" /> <meta name="twitter:site" content="@" /> <meta name="twitter:creator" content="@" /> <meta name="twitter:description" content="개발 블로그입니다. @github." /> <meta name="twitter:image" content="http://localhost:4000/assets/img/ogp.png" /> <link type="application/atom+xml" rel="alternate" href="http://localhost:4000/feed.xml" title="Ohjongsung's Dev Story" /> <link rel="apple-touch-icon" sizes="180x180" href="/assets/favicons/apple-touch-icon.png" /> <link rel="icon" type="image/png" sizes="32x32" href="/assets/favicons/favicon-32x32.png" /> <link rel="icon" type="image/png" sizes="16x16" href="/assets/favicons/favicon-16x16.png" /> <link rel="manifest" href="/assets/favicons/site.webmanifest" /> <link rel="mask-icon" href="/assets/favicons/safari-pinned-tab.svg" color="#5bbad5" /> <meta name="apple-mobile-web-app-title" content="Jekyll Klise" /> <meta name="application-name" content="Jekyll Klise" /> <meta name="msapplication-TileColor" content="#da532c" /> <meta name="theme-color" content="#2c2c2c" /> <link rel="stylesheet" href="/assets/css/style.css" /> </head> <body data-theme="light" class="notransition"> <script> const body = document.body; const data = body.getAttribute("data-theme"); const initTheme = (state) => { if (state === "dark") { body.setAttribute("data-theme", "dark"); } else if (state === "light") { body.removeAttribute("data-theme"); } else { localStorage.setItem("theme", data); } }; initTheme(localStorage.getItem("theme")); setTimeout(() => body.classList.remove("notransition"), 75); </script> <div class="navbar" role="navigation"> <nav class="menu"> <input type="checkbox" id="menu-trigger" class="menu-trigger" /> <label for="menu-trigger"> <span class="menu-icon"> <svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 512 512" > <path d="M64,384H448V341.33H64Zm0-106.67H448V234.67H64ZM64,128v42.67H448V128Z" /> </svg> </span> </label> <a id="mode"> <svg class="mode-sunny" xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 512 512" > <title>LIGHT</title> <line x1="256" y1="48" x2="256" y2="96" style="stroke-linecap:round;stroke-miterlimit:10;stroke-width:32px" /> <line x1="256" y1="416" x2="256" y2="464" style="stroke-linecap:round;stroke-miterlimit:10;stroke-width:32px" /> <line x1="403.08" y1="108.92" x2="369.14" y2="142.86" style="stroke-linecap:round;stroke-miterlimit:10;stroke-width:32px" /> <line x1="142.86" y1="369.14" x2="108.92" y2="403.08" style="stroke-linecap:round;stroke-miterlimit:10;stroke-width:32px" /> <line x1="464" y1="256" x2="416" y2="256" style="stroke-linecap:round;stroke-miterlimit:10;stroke-width:32px" /> <line x1="96" y1="256" x2="48" y2="256" style="stroke-linecap:round;stroke-miterlimit:10;stroke-width:32px" /> <line x1="403.08" y1="403.08" x2="369.14" y2="369.14" style="stroke-linecap:round;stroke-miterlimit:10;stroke-width:32px" /> <line x1="142.86" y1="142.86" x2="108.92" y2="108.92" style="stroke-linecap:round;stroke-miterlimit:10;stroke-width:32px" /> <circle cx="256" cy="256" r="80" style="stroke-linecap:round;stroke-miterlimit:10;stroke-width:32px" /> </svg> <svg class="mode-moon" xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 512 512" > <title>DARK</title> <line x1="256" y1="48" x2="256" y2="96" style="stroke-linecap:round;stroke-miterlimit:10;stroke-width:32px" /> <line x1="256" y1="416" x2="256" y2="464" style="stroke-linecap:round;stroke-miterlimit:10;stroke-width:32px" /> <line x1="403.08" y1="108.92" x2="369.14" y2="142.86" style="stroke-linecap:round;stroke-miterlimit:10;stroke-width:32px" /> <line x1="142.86" y1="369.14" x2="108.92" y2="403.08" style="stroke-linecap:round;stroke-miterlimit:10;stroke-width:32px" /> <line x1="464" y1="256" x2="416" y2="256" style="stroke-linecap:round;stroke-miterlimit:10;stroke-width:32px" /> <line x1="96" y1="256" x2="48" y2="256" style="stroke-linecap:round;stroke-miterlimit:10;stroke-width:32px" /> <line x1="403.08" y1="403.08" x2="369.14" y2="369.14" style="stroke-linecap:round;stroke-miterlimit:10;stroke-width:32px" /> <line x1="142.86" y1="142.86" x2="108.92" y2="108.92" style="stroke-linecap:round;stroke-miterlimit:10;stroke-width:32px" /> <circle cx="256" cy="256" r="80" style="stroke-linecap:round;stroke-miterlimit:10;stroke-width:32px" /> </svg> </a> <div class="trigger"> <div class="trigger-container"><a class="menu-link" href="/">home</a><a class="menu-link" href="/archive/">archive</a><a class="menu-link" href="https://github.com/ohjongsung" target="_blank" rel="noopener" >github</a ><a class="menu-link rss" href="/feed.xml"> <svg xmlns="http://www.w3.org/2000/svg" width="17" height="17" viewBox="0 0 512 512" fill="#ED812E" > <title>RSS</title> <path d="M108.56,342.78a60.34,60.34,0,1,0,60.56,60.44A60.63,60.63,0,0,0,108.56,342.78Z" /> <path d="M48,186.67v86.55c52,0,101.94,15.39,138.67,52.11s52,86.56,52,138.67h86.66C325.33,312.44,199.67,186.67,48,186.67Z" /> <path d="M48,48v86.56c185.25,0,329.22,144.08,329.22,329.44H464C464,234.66,277.67,48,48,48Z" /> </svg> </a> </div> </div> </nav> </div> <div class="wrapper post"> <main class="page-content" aria-label="Content"> <article itemscope itemtype="https://schema.org/BlogPosting"> <header class="header"> <h1 class="header-title" itemprop="headline">카프카 파티션 수 설계</h1> <div class="post-meta"> <time datetime="2020-01-11T00:00:00+09:00" itemprop="datePublished"> 2020-01-11 </time> <span itemprop="author" itemscope itemtype="https://schema.org/Person"> <span itemprop="name">Ohjongsung's Dev Story</span> </span> <time hidden datetime="" itemprop="dateModified"> Jan 11, 2020 </time> <span hidden itemprop="publisher" itemtype="Person">Ohjongsung's Dev Story</span> <span hidden itemprop="image"></span> <span hidden itemprop="mainEntityOfPage"><p>카프카에 파티션 수가 늘어날 수록 처리량을 올라가지만, 그에 따른 반작용이 있다. 바로 Latency 증가하고 recovery time 이 늘어난다. 그래서 무작정 파티션 수를 늘리는 것보다, 적절한 목표 처리량을 설정하고 그에 맞춰 파티션 개수를 산정해야한다.</p> </span> </div> </header> <div class="page-content" itemprop="articleBody"> <p>카프카에 파티션 수가 늘어날 수록 처리량을 올라가지만, 그에 따른 반작용이 있다. 바로 Latency 증가하고 recovery time 이 늘어난다. 그래서 무작정 파티션 수를 늘리는 것보다, 적절한 목표 처리량을 설정하고 그에 맞춰 파티션 개수를 산정해야한다.</p> <h2 id="카프카-파티션-수-설계-가이드"> <a href="#카프카-파티션-수-설계-가이드" class="anchor-head"></a> 카프카 파티션 수 설계 가이드 </h2> <ul> <li><strong>파티션 수를 증가하면 처리량이 높아짐 (분산효과)</strong> <ul> <li>프로듀서, 브로커 : write 처리량이 증가, hardware 자원 사용 증가</li> <li>컨슈머 : 파티션 수만큼 병렬 쓰레드 구동해서 처리량 증가</li> <li>목표 처리량 (t) 이 있다면, 파티션 개수를 정할 수 있음 <ul> <li>단일 파티션 쓰기 속도 계산 (p)</li> <li>단일 파티션 읽기 속도 계산 (c)</li> <li>파티션 개수 = max (t/p, t/c)</li> </ul> </li> <li>고려사항 <ul> <li>batch size, compression type, acks, replication factor 등에 따라 처리 성능이 달라짐</li> <li>Key 별로 파티션 할당해야 하는 경우, 향후 증가량을 고려해서 개수 할당</li> </ul> </li> </ul> </li> <li><strong>각 파티션은 브로커의 특정 directory(log) 에 저장됨</strong> <ul> <li>log segment 당 2개의 파일 생성 (index, data)</li> <li>카프카는 모든 log segment 의 index 와 data file handler 를 오픈</li> <li>파티션이 많아지면, OS 의 file handler 관련 설정 변경이 필요 (걍 미리 올려놓자)</li> </ul> </li> <li><strong>파티션 수를 증가하면 서비스 리커버리 시간이 증가함</strong> <ul> <li>카프카는 가용성과 유실 방지를 위해, 복제복(replicat) 를 생성</li> <li>leader broker 는 복제본 중 1개를 가지고 있고, 다운되면 순간적으로 leader 의 파티션은 서비스 불가능해짐 <ul> <li>대부분 브로커는 정상적으로 다운되어, 사전에 파티션의 리더를 변경 (controller broker 의 역할)</li> <li>하나의 파티션 리더 변경은 순식간에 실행되어, 컨슈머 관점에서는 잠깐 접속이 안되는 상황 발생</li> </ul> </li> <li>만약 브로커에 1000 개의 파티션이 있고, 비정상 종료(kill -9) 되었다면? <ul> <li>파티션의 서비스 중지 시간은 파티션 개수에 비례</li> <li>하나의 파티션 리더 선출하는 시간이 5ms</li> <li>1000 파티션이면 5 sec 소요 ( 5초동안 서비스 불가)</li> <li>만약 controller broker 가 다운되었다면? 새로운 controller 가 실행될때까지 모든 파티션의 리더 선출 불가능</li> </ul> </li> </ul> </li> <li><strong>파티션 수를 증가시키면 ent to ent latency 증가</strong> <ul> <li>프로듀서에서 컨슈머로 메시지 전송은 커밋된 후에 가능 <ul> <li>복제된 메시지가 모두 ISR 상태에 있는 것을 의미</li> <li>카프카는 브로커간의 데이터 복제에 single thread 만 사용</li> <li>1000 개의 파티션을 다른 브로커로 복제하는데 20ms 소요 (latency 에 영향)</li> <li>클러스터가 크다면 (브로커 노드가 많다면), 1000개의 파티션이 여러 브로커에 분산복제되어 복사속도는 줄어듬</li> </ul> </li> <li>latency 가 중요하다면 <ul> <li>브로커 당 파티션 개수를 제한</li> <li>파티션 수 = 100 * b * r</li> <li>b : 브로커 수</li> <li>r : replication factor 수</li> </ul> </li> </ul> </li> </ul> </div> </article> </main> <nav class="post-nav"> <a class="post-nav-item post-nav-prev" href="/%EC%B9%B4%ED%94%84%EC%B9%B4-%ED%8A%9C%EB%8B%9D-%EB%B0%A9%EC%95%88-%EC%A0%95%EB%A6%AC/" > <div class="nav-arrow">Previous</div> <span class="post-title">카프카 튜닝 방안 정리</span> </a> <a class="post-nav-item post-nav-next" href="/Nginx-tuning-%EC%A0%95%EB%A6%AC/"> <div class="nav-arrow">Next</div> <span class="post-title">Nginx Tuning 정리</span> </a> </nav> <footer class="footer"> <!--<a class="footer_item" href="/thanks">ack.</a> <a class="footer_item" href="javascript::void(0)">resume</a>--> <a class="footer_item" href="/feed.xml">rss</a> <span class="footer_item">&copy; 2022</span> <small class="footer_copyright"> <!-- Klisé Theme: https://github.com/piharpi/jekyll-klise --> <a href="https://github.com/piharpi/jekyll-klise" target="_blank" rel="noreferrer noopener" >klisé</a > theme on <a href="https://jekyllrb.com" target="_blank" rel="noreferrer noopener" >jekyll</a > </small> </footer> <script src="/assets/js/main.js" defer="defer"></script> </div> </body> </html>
